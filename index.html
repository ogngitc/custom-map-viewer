<script>
  const canvas = document.getElementById("mapCanvas");
  const ctx = canvas.getContext("2d");

  const mapImage = new Image();
  mapImage.src = "shimonita_giopark.jpg";

  const pinImage = new Image();
  pinImage.src = "pin.png";

  const latTop = 36.2, latBottom = 36.0;
  const lngLeft = 138.7, lngRight = 138.9;

  function latLngToXY(lat, lng) {
    const x = ((lng - lngLeft) / (lngRight - lngLeft)) * canvas.width;
    const y = ((latTop - lat) / (latTop - latBottom)) * canvas.height;
    return { x, y };
  }

  mapImage.onload = () => {
    ctx.drawImage(mapImage, 0, 0, canvas.width, canvas.height);

    pinImage.onload = () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude } = pos.coords;
            const { x, y } = latLngToXY(latitude, longitude);

            // 🔍 コンソール出力で座標確認
            console.log("現在地：", latitude, longitude, "→", x, y);

            ctx.drawImage(pinImage, x - 16, y - 32, 32, 32);
            ctx.font = "14px sans-serif";
            ctx.fillStyle = "black";
            ctx.fillText("現在地", x + 16, y - 16);
          },
          (err) => alert("位置情報取得に失敗：" + err.message)
        );
      }
    };

    pinImage.onerror = () => {
      alert("❌ ピン画像の読み込みに失敗しました");
    };
  };

  mapImage.onerror = () => {
    alert("❌ 地図画像の読み込みに失敗しました");
  };
</script>
